var OSDE=OSDE?OSDE:{};OSDE.TreeMap=function(elementID){var self=this,$treemap=$(elementID);var treemap=null,div=null;function create(){var width=$treemap.width(),height=$treemap.height();$treemap.empty();treemap=d3.layout.treemap().size([width,height]).sticky(true).sort(function(a,b){return a.value-b.value}).value(function(d){return d.value});div=d3.select("#treemap").append("div").style("position","relative").style("width",width+"px").style("height",height+"px")}self.render=function render(data,dimension){create();var root={children:[]};for(var i=0;i<data.cells.length;i+=1){root.children.push({name:data.cells[i]._current_label,value:data.cells[i]._value,value_fmt:data.cells[i]._value_fmt,percentage:data.cells[i]._percentage,href:data.cells[i]._url,color:data.cells[i]._color})}var node=div.datum(root).selectAll(".node").data(treemap.nodes).enter().append("a").attr("href",function(d){return d.href}).attr("class","node").call(positionNode).style("background","#fff").classed("big",function(d){return d.value>data.summary._value/50}).html(function(d){if(d.percentage<.03){return""}return d.children?null:'<span class="amount">'+d.value_fmt+"</span>"+d.name}).on("mouseover",function(d){d3.select(this).transition().duration(200).style({background:d3.rgb(d.color).darker()})}).on("mouseout",function(d){d3.select(this).transition().duration(500).style({background:d.color})}).transition().duration(500).delay(function(d,i){return Math.min(i*30,1500)}).style("background",function(d){return d.color})};function positionNode(){this.style("left",function(d){return d.x+"px"}).style("top",function(d){return d.y+"px"}).style("width",function(d){return Math.max(0,d.dx-1)+"px"}).style("height",function(d){return Math.max(0,d.dy-1)+"px"})}};var OSDE=OSDE?OSDE:{};OSDE.Table=function(elementID){var self=this,$table=$(elementID),template=Handlebars.compile($("#table-template").html());self.render=function render(data,dimension){$table.html(template(data));$table.find(".show-small").click(function(){$table.find(".small").slideDown("fast");$table.find(".hide-small").show();$table.find(".show-small").hide();return false});$table.find(".hide-small").click(function(){$table.find(".small").slideUp("fast");$table.find(".show-small").show();$table.find(".hide-small").hide();return false})}};$(function(){var site=JSON.parse($("#site-config").html()),embedTemplate=Handlebars.compile($("#embed-template").html());$embedCode=$("#embed-code");baseFilters={};$.each(site.filters,function(i,f){baseFilters[f.field]=f.default});var $hierarchyMenu=$("#hierarchy-menu"),$infobox=$("#infobox"),$parent=$("#parent"),$filterValues=$(".site-filters .value"),treemap=new OSDE.TreeMap("#treemap"),table=new OSDE.Table("#table");function getData(drilldown,cut){console.log(site);var cutStr=$.map(cut,function(v,k){if((v+"").length){return site.keyrefs[k]+":"+v}});var drilldowns=[site.keyrefs[drilldown]];if(site.keyrefs[drilldown]!=site.labelrefs[drilldown]){drilldowns.push(site.labelrefs[drilldown])}return $.ajax({url:site.api+"/aggregate",crossDomain:true,data:{drilldown:drilldowns.join("|"),cut:cutStr.join("|"),order:site.aggregate+":desc",page:0,pagesize:500},dataType:"json",cache:true})}$("#infobox-toggle").click(function(e){var $e=$(e.target);if($e.hasClass("active")){$e.removeClass("active");$infobox.slideUp()}else{$e.addClass("active");$infobox.slideDown()}return false});function parsePath(hash){var path={},location=hash.split("/"),levels=location.slice(1,location.length-1);path.hierarchyName=location[0];console.log(path);path.hierarchy=site.hierarchies[path.hierarchyName];console.log(site);path.hierarchy.cuts=path.hierarchy.cuts||{};path.level=levels.length;path.root=path.level==0;path.bottom=path.level>=path.hierarchy.drilldowns.length-1;path.drilldown=path.hierarchy.drilldowns[path.level];path.args=OSDE.parseArgs(location[location.length-1]);$.each(levels,function(i,val){path.args[path.hierarchy.drilldowns[i]]=decodeURIComponent(val)});return path}function parentUrl(path){if(path.level<1){return makeUrl(path,null)}var p=$.extend(true,{},path);$.each(p.hierarchy.drilldowns,function(i,drilldown){if(i>=p.level-1){delete p.args[drilldown]}});return makeUrl(p,{})}function makeUrl(path,modifiers){var args=$.extend({},path.args,modifiers),url="#"+path.hierarchyName+"/";if(!modifiers)args={};$.each(path.hierarchy.drilldowns,function(i,drilldown){if(args[drilldown]){url+=args[drilldown]+"/";delete args[drilldown]}});return url+OSDE.mergeArgs(args)}function update(){var rawPath=window.location.hash.substring(1);if(!rawPath.length){rawPath=site.default+"/"}var path=parsePath(rawPath),rootDimension=path.hierarchy.drilldowns[0],rootColor=null;color=d3.scale.ordinal().range(OSDE.categoryColors),cuts=$.extend({},baseFilters,path.hierarchy.cuts||{},path.args);$hierarchyMenu.find(".btn").removeClass("active");$hierarchyMenu.find(".btn."+path.hierarchyName).addClass("active");$parent.unbind();if(path.root){$parent.hide()}else{$parent.show();$parent.attr("href",parentUrl(path))}$filterValues.removeClass("active");$filterValues.each(function(i,f){var $f=$(f),field=$f.data("field"),value=$f.data("value"),modifiers={};modifiers[field]=value;$f.attr("href",makeUrl(path,modifiers));if(cuts[field]==value){$f.addClass("active")}});$.each(site.filters,function(i,f){var val=cuts[f.field],label=val;$.each(f.values,function(j,v){if(v.key==val){label=v.label}});$('.site-filters strong[data-field="'+f.field+'"]').html(label||"Alle")});var baseCuts=$.extend({},baseFilters,path.hierarchy.cuts);getData(rootDimension,baseCuts).done(function(base){$.each(base.cells,function(i,drilldown){drilldown._color=color(i);var rootRef=site.keyrefs[rootDimension];if(cuts[rootDimension]&&cuts[rootDimension]==drilldown[rootRef]){rootColor=d3.rgb(drilldown._color)}});getData(path.drilldown,cuts).done(function(data){var dimension=path.drilldown;if(dimension!=rootDimension){color=d3.scale.linear();color=color.interpolate(d3.interpolateRgb);color=color.range([rootColor.brighter(),rootColor.darker().darker()]);color=color.domain([data.total_cell_count,0])}data.summary._value=data.summary[site.aggregate];data.summary._value_fmt=OSDE.amount(data.summary._value);$.each(data.cells,function(e,cell){cell._current_label=cell[site.labelrefs[dimension]];cell._current_key=cell[site.keyrefs[dimension]];cell._value=cell[site.aggregate];cell._value_fmt=OSDE.amount(cell._value);cell._percentage=cell[site.aggregate]/data.summary[site.aggregate];cell._small=cell._percentage<.01;cell._percentage_fmt=(cell._percentage*100).toFixed(2)+"%";cell._percentage_fmt=cell._percentage_fmt.replace(".",",");if(!path.bottom){var modifiers={};modifiers[dimension]=cell._current_key;cell._url=makeUrl(path,modifiers)}else{cell._no_url=true}cell._color=color(e)});treemap.render(data,path.drilldown);table.render(data,path.drilldown)})});$embedCode.text(embedTemplate({name:site.name,baseurl:document.location.href.split("#")[0],url:document.location.href,hash:document.location.hash}))}hashtrack.onhashchange(update)});
